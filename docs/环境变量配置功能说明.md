# CLI 工具环境变量配置功能说明

## 功能概述

本功能允许用户在页面上配置不同 CLI 工具的环境变量,配置会保存到数据库中,优先于 `appsettings.json` 配置文件中的设置。

## 实现架构

### 1. 数据库层

**实体模型**: `CliToolEnvironmentVariable.cs`
- 存储每个 CLI 工具的环境变量键值对
- 支持按 ToolId 分组管理

**仓储层**:
- `ICliToolEnvironmentVariableRepository` - 仓储接口
- `CliToolEnvironmentVariableRepository` - 仓储实现
- 提供基本的 CRUD 操作

### 2. 服务层

**环境变量服务**: `CliToolEnvironmentService.cs`
- `GetEnvironmentVariablesAsync()` - 获取环境变量(优先数据库,降级到配置文件)
- `SaveEnvironmentVariablesAsync()` - 保存环境变量到数据库
- `DeleteEnvironmentVariablesAsync()` - 删除环境变量配置
- `ResetToDefaultAsync()` - 重置为配置文件中的默认值

**CLI执行服务**: `CliExecutorService.cs`
- 集成环境变量服务
- 在执行 CLI 命令时自动加载正确的环境变量
- 支持持久化进程和一次性进程两种模式

### 3. 前端UI层

**组件**: `EnvironmentVariableConfigModal.razor`
- 环境变量配置模态框
- 支持添加/编辑/删除环境变量
- 支持重置为默认配置

**页面**: `CodeAssistant.razor`
- 添加"环境变量"按钮
- 集成配置模态框

## 使用说明

### 1. 数据库初始化

首次使用前需要执行数据库迁移脚本:
```sql
-- 见 docs/数据库迁移-环境变量配置.sql
```

### 2. 页面操作

1. 在编程助手页面,选择要配置的 CLI 工具
2. 点击"环境变量"按钮打开配置窗口
3. 添加或编辑环境变量:
   - 键名: 例如 `OPENAI_API_KEY`
   - 键值: 例如 `sk-xxx`
4. 点击"保存"按钮保存到数据库
5. 点击"重置为默认"可恢复 appsettings.json 中的配置

### 3. 配置优先级

环境变量的加载顺序:
1. **数据库配置** (最高优先级)
2. **appsettings.json 配置** (降级方案)
3. **空配置** (无任何配置时)

### 4. 配置示例

#### appsettings.Development.json 示例:
```json
{
  "CliTools": {
    "Tools": [
      {
        "Id": "qwen-code",
        "Name": "QwenCode",
        "EnvironmentVariables": {
          "OPENAI_BASE_URL": "https://api.example.com/v1",
          "OPENAI_API_KEY": "sk-default-key",
          "OPENAI_MODEL": "gpt-4"
        }
      }
    ]
  }
}
```

#### 页面配置后(保存到数据库):
- 用户可以覆盖上述任何环境变量
- 配置会立即生效,不需要重启应用
- 可以随时重置为默认配置

## 技术细节

### 1. 依赖注入

服务自动注册(通过 `ServiceDescription` 特性):
- `ICliToolEnvironmentVariableRepository` (Scoped)
- `ICliToolEnvironmentService` (Scoped)
- `ICliExecutorService` (Singleton)

### 2. 数据库表结构

```sql
CREATE TABLE cli_tool_environment_variables (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    tool_id TEXT NOT NULL,           -- CLI 工具 ID
    key TEXT NOT NULL,                -- 环境变量键
    value TEXT,                       -- 环境变量值
    created_at DATETIME NOT NULL,     -- 创建时间
    updated_at DATETIME NOT NULL      -- 更新时间
);
```

### 3. 性能优化

- 使用索引优化查询: `idx_cli_env_tool_id`, `idx_cli_env_tool_key`
- 唯一索引防止重复键
- 内存缓存降级方案(配置文件)

### 4. 错误处理

- 数据库操作失败时降级到配置文件
- 详细的日志记录
- 友好的用户提示

## 扩展功能

### 未来可以添加:

1. **环境变量模板**
   - 预定义常用环境变量模板
   - 一键导入模板配置

2. **环境变量加密**
   - 对敏感信息(如 API Key)进行加密存储
   - 使用安全的加密算法

3. **配置历史记录**
   - 记录每次配置变更
   - 支持回滚到历史配置

4. **批量导入/导出**
   - JSON 格式导入导出
   - 支持配置迁移

5. **权限控制**
   - 不同用户不同的环境变量
   - 管理员统一配置

## 注意事项

1. **敏感信息**:环境变量可能包含敏感信息(API Key等),建议:
   - 在生产环境启用数据库加密
   - 限制数据库访问权限
   - 定期轮换密钥

2. **配置生效**:
   - 一次性进程模式: 每次执行都会重新加载配置
   - 持久化进程模式: 需要重启进程(清空会话)才能生效新配置

3. **配置备份**:
   - 定期备份数据库
   - 保留 appsettings.json 作为默认配置

## 相关文件

### 后端文件:
- `WebCodeCli.Domain/Domain/Model/CliToolEnvironmentVariable.cs`
- `WebCodeCli.Domain/Repositories/Base/CliToolEnv/ICliToolEnvironmentVariableRepository.cs`
- `WebCodeCli.Domain/Repositories/Base/CliToolEnv/CliToolEnvironmentVariableRepository.cs`
- `WebCodeCli.Domain/Domain/Service/CliToolEnvironmentService.cs`
- `WebCodeCli.Domain/Domain/Service/CliExecutorService.cs`
- `WebCodeCli.Domain/Domain/Service/ICliExecutorService.cs`

### 前端文件:
- `WebCodeCli/Components/EnvironmentVariableConfigModal.razor`
- `WebCodeCli/Pages/CodeAssistant.razor`
- `WebCodeCli/Pages/CodeAssistant.razor.cs`
- `WebCodeCli/_Imports.razor`

### 数据库文件:
- `docs/数据库迁移-环境变量配置.sql`
